<div class="batch-container">

  <!-- FORMULARIO DE EDICIÓN -->
  <ng-container *ngIf="editMode && selectedBatch">
    <h2>Editar lote {{ selectedBatch.code }} – {{ selectedBatch.client }}</h2>

    <form [formGroup]="editForm" (ngSubmit)="onEditSubmit()" class="form-container">

      <app-input label="Código del Lote" formControlName="code" [required]="true"></app-input>
      <app-input label="Cliente" formControlName="client" [required]="true"></app-input>
      <app-input label="Tipo de tela" formControlName="fabricType" [required]="true"></app-input>
      <app-input label="Color del lote" formControlName="color"></app-input>
      <app-input label="Cantidad" type="number" formControlName="quantity" [required]="true"></app-input>
      <app-input label="Precio" type="number" formControlName="price" [required]="true"></app-input>
      <app-input label="Observaciones" type="textarea" formControlName="observations"></app-input>
      <app-input label="Fecha de registro" type="date" formControlName="date" [required]="true"></app-input>

      <div class="button-group">
        <app-button label="Cancelar" icon="close" variant="secondary" (click)="cancelEdit()"></app-button>
        <app-button label="Guardar" icon="save" variant="primary" [attr.type]="'submit'" [disabled]="editForm.invalid"></app-button>
      </div>
    </form>
  </ng-container>

  <!-- TABLA -->
  <ng-container *ngIf="!editMode">
    <div class="table-header">
      <input matInput (input)="applyFilter($event)" placeholder=" Buscar lote" class="search-input" />
      <button mat-icon-button (click)="downloadCSV()" matTooltip="Descargar CSV">
        <mat-icon>file_download</mat-icon>
      </button>
    </div>

    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
      <ng-container matColumnDef="code">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Código</th>
        <td mat-cell *matCellDef="let element">{{ element.code }}</td>
      </ng-container>

      <ng-container matColumnDef="client">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
        <td mat-cell *matCellDef="let element">{{ element.client }}</td>
      </ng-container>

      <ng-container matColumnDef="fabricType">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo de Tela</th>
        <td mat-cell *matCellDef="let element">{{ element.fabricType }}</td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
        <td mat-cell *matCellDef="let element">{{ element.date | date:'dd/MM/yy' }}</td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
        <td mat-cell *matCellDef="let element">
          <span [ngClass]="{
            'status-green': element.status === 'Enviado',
            'status-yellow': element.status === 'Por enviar'
          }">●</span>
          {{ element.status }}
        </td>
      </ng-container>

      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
        <td mat-cell *matCellDef="let element">S/ {{ element.price }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button (click)="toggleStatus(element)" matTooltip="Cambiar estado">
            <mat-icon>autorenew</mat-icon>
          </button>
          <button mat-icon-button (click)="editBatch(element)" matTooltip="Editar lote">
            <mat-icon>edit</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
  </ng-container>

  <!--  NOTIFICACIONES GLOBALES -->
  <app-notification
    [show]="showEditSuccess"
    (showChange)="showEditSuccess = $event"
    message="Lote actualizado con éxito."
    type="success"
    [autoClose]="true"
    [duration]="2500"
    buttonText="OK">
  </app-notification>

  <app-notification
    [show]="showEditError"
    (showChange)="showEditError = $event"
    message=" Error al actualizar el lote."
    type="error"
    [autoClose]="true"
    [duration]="3000"
    buttonText="Cerrar">
  </app-notification>

  <app-notification
    [show]="showEditCancel"
    (showChange)="showEditCancel = $event"
    message=" Edición cancelada."
    type="info"
    [autoClose]="true"
    [duration]="2500"
    buttonText="OK">
  </app-notification>

</div>
