import{s as T}from"./chunk-6CUNOLLP.js";import{a as c,b as I}from"./chunk-QHSPJAHQ.js";import{C as v,Z as m,ca as d,d as y,ra as f,s as u}from"./chunk-3V6P7TZ6.js";var g=class{id;name;email;password;role;country;city;address;phone;constructor(r){r.id&&(this.id=r.id),this.name=r.name||"",this.email=r.email||"",this.password=r.password,this.role=r.role||"pending",this.country=r.country||"",this.city=r.city||"",this.address=r.address||"",this.phone=r.phone||""}};var p=class n{MAX_SESSION_DURATION=8*60*60*1e3;INACTIVITY_TIMEOUT=30*60*1e3;inactivityTimeoutId;sessionTimeoutId;constructor(){}init(r){["mousedown","mousemove","keypress","scroll","touchstart"].forEach(s=>{window.addEventListener(s,()=>this.resetInactivityTimer(r))}),window.addEventListener("beforeunload",()=>{r.isAuthenticated()&&this.endSession()}),this.checkExistingSession(r)}checkExistingSession(r){let e=sessionStorage.getItem("session_start");if(r.isAuthenticated()&&e){let s=parseInt(e),o=Date.now()-s;if(o>=this.MAX_SESSION_DURATION){console.log("Sesi\xF3n expirada por tiempo m\xE1ximo (8 horas)"),r.logout();return}let l=this.MAX_SESSION_DURATION-o;this.resetInactivityTimer(r),this.startSessionTimer(r,l)}}startSessionTimer(r,e=this.MAX_SESSION_DURATION){this.sessionTimeoutId&&clearTimeout(this.sessionTimeoutId),this.sessionTimeoutId=setTimeout(()=>{r.isAuthenticated()&&(console.log("Sesi\xF3n cerrada por tiempo m\xE1ximo (8 horas)"),r.logout())},e)}resetInactivityTimer(r){this.inactivityTimeoutId&&clearTimeout(this.inactivityTimeoutId),this.inactivityTimeoutId=setTimeout(()=>{r.isAuthenticated()&&(console.log("Sesi\xF3n cerrada por inactividad"),r.logout())},this.INACTIVITY_TIMEOUT)}startSession(r){this.clearAllTimers(),sessionStorage.setItem("session_start",Date.now().toString()),this.startSessionTimer(r),this.resetInactivityTimer(r)}endSession(){this.clearAllTimers(),sessionStorage.removeItem("session_start")}clearAllTimers(){this.inactivityTimeoutId&&clearTimeout(this.inactivityTimeoutId),this.sessionTimeoutId&&clearTimeout(this.sessionTimeoutId)}getSessionInfo(){let r=sessionStorage.getItem("session_start");if(!r)return{startTime:null,remainingTime:null,isActive:!1};let e=parseInt(r),t=Date.now()-e,o=Math.max(0,this.MAX_SESSION_DURATION-t);return{startTime:e,remainingTime:o,isActive:o>0}}static \u0275fac=function(e){return new(e||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};var b=class n extends I{constructor(e,s,t){super();this.router=e;this.sessionService=s;this.injector=t;this.resourceEndpoint=c.userEndpointPath,this.checkAndCleanPreviousSession(),this.sessionService.init(this)}checkAndCleanPreviousSession(){let e=sessionStorage.getItem("session_start"),s=localStorage.getItem("auth_token"),t=localStorage.getItem("current_user");if(!e&&(s||t)){console.log("\u{1F9F9} Limpiando sesi\xF3n anterior - Nueva sesi\xF3n del navegador detectada"),this.clearAllSessionData();return}if(e&&s){let o=parseInt(e),l=Date.now(),h=8*60*60*1e3;if(l-o>=h){console.log("\u{1F9F9} Limpiando sesi\xF3n anterior - Sesi\xF3n expirada por tiempo"),this.clearAllSessionData();return}}}clearAllSessionData(){localStorage.removeItem("auth_token"),localStorage.removeItem("current_user"),localStorage.removeItem("userLanguage"),sessionStorage.removeItem("session_start"),console.log("\u2705 Todos los datos de sesi\xF3n anterior han sido limpiados")}checkEmailExists(e){return this.customRequest("/users","GET").pipe(u(s=>s.some(t=>t.email===e)))}loginUser(e){let s={email:e.email,password:e.password};return this.customRequest("/authentication/sign-in","POST",s,!1).pipe(u(t=>(this.saveSession(t.token,this.transformBackendUserToFrontend(t)),this.loadUserConfigurations(t.id.toString(),!0).then(()=>{this.redirectBasedOnRole(t.role)}),!0)),v(t=>{throw console.error("\u274C Error en login:",t),t}))}registerUser(e){let s={email:e.email,password:e.password,name:e.name,country:e.country,city:e.city,address:e.address,phone:e.phone,role:"PENDING"};return this.customRequest("/authentication/sign-up","POST",s,!1).pipe(u(t=>(console.log("Usuario registrado exitosamente:",t),this.loginUser({email:e.email,password:e.password}).subscribe({next:o=>{o&&console.log("\u2705 Login autom\xE1tico exitoso despu\xE9s del registro")},error:o=>{console.error("\u274C Error en login autom\xE1tico:",o)}}),!0)),v(t=>{throw console.error("\u274C Error en registro:",t),t}))}login(e){this.loginUser(e).subscribe({next:s=>{console.log("Login completado")},error:s=>{console.error("Error en login (m\xE9todo legacy):",s)}})}register(e){this.registerUser(e).subscribe({next:s=>{console.log("Registro completado")},error:s=>{console.error("Error en registro (m\xE9todo legacy):",s)}})}setUserRole(e){let s=this.getCurrentUser();if(!s||!s.id){console.error("No hay usuario actual o no tiene ID");return}let t={role:e.toUpperCase()};this.customRequest(`/users/${s.id}/role`,"PUT",t).subscribe({next:o=>{let l=this.transformBackendUserToFrontend(o);this.setCurrentUser(l),this.createProfileForRole(e,s.id),this.redirectBasedOnRole(e)},error:o=>{console.error("Error al actualizar rol:",o)}})}transformBackendUserToFrontend(e){return new g({id:e.id?.toString()||"",name:e.name||"",email:e.email||"",role:e.role?.toLowerCase()||"pending",country:e.country||"",city:e.city||"",address:e.address||"",phone:e.phone||""})}transformFrontendUserToBackend(e){return{id:e.id?parseInt(e.id):void 0,name:e.name,email:e.email,password:e.password,role:e.role?.toUpperCase(),country:e.country,city:e.city,address:e.address,phone:e.phone}}loadUserConfigurations(e,s=!0){return y(this,null,function*(){try{console.log(`\u2699\uFE0F Cargando configuraciones del usuario... (inicial: ${s})`);let[t,o,l]=yield Promise.all([import("./chunk-WKFF3JNY.js"),import("./chunk-G3NAIULG.js"),import("./chunk-RPBDUPWB.js")]),h=this.injector.get(t.ConfigurationService),S=this.injector.get(o.ThemeService),w=this.injector.get(l.TranslateService);h.getByUserId(e).subscribe({next:a=>{let i=null;Array.isArray(a)&&a.length>0?i=a[0]:!Array.isArray(a)&&a&&(i=a),i?(console.log("\u{1F4CB} Aplicando configuraciones:",i),i.language&&(w.use(i.language),localStorage.setItem("userLanguage",i.language),console.log(`\u{1F30D} Idioma aplicado: ${i.language}`)),i.viewMode&&s?(S.setTheme(i.viewMode),console.log(`\u{1F3A8} Tema aplicado (login inicial): ${i.viewMode}`)):i.viewMode&&!s&&console.log(`\u26A0\uFE0F Tema NO aplicado (recarga): ${i.viewMode}`),console.log("\u2705 Configuraciones aplicadas exitosamente")):console.log("\u26A0\uFE0F No se encontraron configuraciones, usando por defecto")},error:a=>{console.error("\u274C Error al cargar configuraciones:",a)}})}catch(t){console.error("\u274C Error al importar servicios:",t)}})}logout(e=!0){this.clearAllSessionData(),this.sessionService.endSession(),e&&this.router.navigate(["/login"])}createProfileForRole(e,s){console.log(`Creando perfil para rol: ${e}, userId: ${s}`);try{let t={};e==="businessman"?this.customRequest(`/businessmen/${s}`,"POST",t).subscribe({next:o=>{console.log("Perfil businessman creado:",o)},error:o=>{console.error("Error creando perfil businessman:",o)}}):e==="supplier"&&this.customRequest(`/suppliers/${s}`,"POST",t).subscribe({next:o=>{console.log("Perfil supplier creado:",o)},error:o=>{console.error("Error creando perfil supplier:",o)}})}catch(t){console.error("Error al crear perfil:",t)}}redirectBasedOnRole(e){console.log("Redirigiendo seg\xFAn rol:",e);let s=e.toLowerCase();s==="businessman"?this.router.navigate(["/businessman/planes"]):s==="supplier"?this.router.navigate(["/supplier/planes"]):s==="pending"?this.router.navigate(["/select-role"]):this.router.navigate(["/login"])}getCurrentUser(){let e=localStorage.getItem("current_user");if(e)try{return JSON.parse(e)}catch{return console.error("Error parsing user data"),null}return null}getCurrentUserRole(){let e=this.getCurrentUser();return e?e.role:null}isAuthenticated(){let e=localStorage.getItem("auth_token"),s=sessionStorage.getItem("session_start"),t=!!e&&!e.startsWith("fake-jwt-token-")&&!e.startsWith("temp-jwt-token-"),o=!!s;return t&&!o?(console.log("\u{1F9F9} Token encontrado sin sesi\xF3n activa - Limpiando datos"),this.clearAllSessionData(),!1):t&&o}saveSession(e,s){localStorage.setItem("auth_token",e),localStorage.setItem("current_user",JSON.stringify(s)),this.sessionService.startSession(this)}updateUser(e,s){let t=this.transformFrontendUserToBackend(s);return this.customRequest(`/users/${e}`,"PUT",t).pipe(u(o=>this.transformBackendUserToFrontend(o)))}setCurrentUser(e){localStorage.setItem("current_user",JSON.stringify(e)),console.log("\u2705 Usuario actual actualizado:",e)}getCurrentUserProfile(){let e=this.getCurrentUser();if(!e||!e.id)throw new Error("No hay usuario actual");return this.customRequest(`/profiles/${e.id}`,"GET")}forgotPassword(e){let s={email:e},t=`${c.serverBaseUrl}${c.authEndpointPath}/forgot-password`;return this.http.post(t,s,{responseType:"text"})}resetPassword(e,s){let t={token:e,newPassword:s},o=`${c.serverBaseUrl}${c.authEndpointPath}/reset-password`;return this.http.post(o,t,{responseType:"text"})}static \u0275fac=function(s){return new(s||n)(d(T),d(p),d(f))};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{g as a,b};
